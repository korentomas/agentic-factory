name: Agent Triage

# Replaces direct dispatch with an intelligent triage step.
# Reads the issue + codebase context, evaluates clarity, and either:
#   1. Posts a specification comment and dispatches to agent-write
#   2. Posts a clarifying question and waits for the author to respond
#
# Also triggers on issue comments ‚Äî so when someone answers a clarification
# question, triage re-runs with the enriched context.

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  triage:
    name: "Triage: Evaluate Issue"
    # Run when:
    # 1. A new issue is opened (automatic pickup), OR
    # 2. Issue is labeled "ai-agent" (manual trigger for existing issues), OR
    # 3. A comment is posted on an issue with "needs-clarification" label
    #    (someone answered a clarification question)
    if: |
      !startsWith(github.head_ref || github.ref_name, 'selfheal-') &&
      (
        (github.event_name == 'issues' && github.event.action == 'opened') ||
        (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'ai-agent') ||
        (github.event_name == 'issue_comment' &&
         contains(github.event.issue.labels.*.name, 'needs-clarification') &&
         github.event.comment.user.login != 'agentfactory-bot[bot]')
      )
    runs-on: ubuntu-latest
    outputs:
      is_clear: ${{ steps.parse.outputs.is_clear }}
      task_id: ${{ steps.meta.outputs.task_id }}
      title: ${{ steps.meta.outputs.title }}
      complexity: ${{ steps.meta.outputs.complexity }}
      risk_tier: ${{ steps.meta.outputs.risk_tier }}
      issue_number: ${{ steps.meta.outputs.issue_number }}
      question: ${{ steps.parse.outputs.question }}
      default: ${{ steps.parse.outputs.default }}
      why: ${{ steps.parse.outputs.why }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: React with eyes to acknowledge
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # React to the issue itself
          gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/reactions" \
            --method POST -f content=eyes 2>/dev/null || true
          # If triggered by a comment reply, also react to that comment
          if [ "${EVENT_NAME}" = "issue_comment" ] && [ -n "${COMMENT_ID}" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}/reactions" \
              --method POST -f content=eyes 2>/dev/null || true
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Extract issue metadata
        id: meta
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Get the issue number regardless of trigger type
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          echo "issue_number=${ISSUE_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "task_id=gh-${ISSUE_NUMBER}" >> "$GITHUB_OUTPUT"

          # Get full issue data including all comments
          ISSUE_TITLE=$(gh issue view "${ISSUE_NUMBER}" --json title -q .title)
          ISSUE_BODY=$(gh issue view "${ISSUE_NUMBER}" --json body -q .body)
          # Use heredoc for title in case it contains special characters
          {
            echo "title<<TITLE_EOF"
            echo "${ISSUE_TITLE}"
            echo "TITLE_EOF"
          } >> "$GITHUB_OUTPUT"

          # Determine complexity from body length + structure
          BODY_LENGTH=${#ISSUE_BODY}
          if [ "$BODY_LENGTH" -gt 500 ]; then
            echo "complexity=high" >> "$GITHUB_OUTPUT"
          else
            echo "complexity=standard" >> "$GITHUB_OUTPUT"
          fi

          # Determine risk tier from content
          COMBINED="${ISSUE_TITLE} ${ISSUE_BODY}"
          COMBINED_LOWER=$(echo "$COMBINED" | tr '[:upper:]' '[:lower:]')

          if echo "$COMBINED_LOWER" | grep -qE "auth|tenant|security|migration|schema|admin|password|token|credential|secret"; then
            echo "risk_tier=high" >> "$GITHUB_OUTPUT"
          elif echo "$COMBINED_LOWER" | grep -qE "api|endpoint|route|service|webhook|billing"; then
            echo "risk_tier=medium" >> "$GITHUB_OUTPUT"
          else
            echo "risk_tier=low" >> "$GITHUB_OUTPUT"
          fi

          # Gather all conversation context (issue body + comments)
          COMMENTS=$(gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" \
            --jq '[.[] | select(.user.login != "agentfactory-bot[bot]") | .body] | join("\n\n---\n\n")' \
            2>/dev/null || echo "")

          # Write full context to a file for Claude to read
          {
            echo "# Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}"
            echo ""
            echo "## Description"
            echo "${ISSUE_BODY}"
            if [ -n "$COMMENTS" ]; then
              echo ""
              echo "## Additional Context (from comments)"
              echo "${COMMENTS}"
            fi
          } > /tmp/issue_context.md

      - name: Triage with agent
        id: triage
        continue-on-error: true
        uses: ./.github/actions/run-agent
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          engine: ${{ vars.TRIAGE_ENGINE || 'claude-code' }}
          prompt: |
            You are triaging a GitHub issue. Read /tmp/issue_context.md.

            Quickly evaluate:
            1. Is the desired behavior clearly described?
            2. Are acceptance criteria specified or inferable?
            3. Are there ambiguous requirements with multiple valid interpretations?

            Write your result to /tmp/triage_result.json:
            {
              "is_clear": true,
              "confidence": 0.9,
              "clarification_needed": null
            }

            Or if unclear:
            {
              "is_clear": false,
              "confidence": 0.4,
              "clarification_needed": {
                "question": "ONE specific question",
                "default_assumption": "what you'd assume if no answer",
                "why": "brief reason"
              }
            }

            Rules:
            - confidence >= 0.8 ‚Üí is_clear = true
            - Multiple valid interpretations ‚Üí is_clear = false
            - Write the JSON file immediately, do not over-analyze
          model: ${{ vars.TRIAGE_MODEL || vars.CLAUDE_SONNET_MODEL || 'claude-sonnet-4-6' }}
          max_turns: "5"
          allowed_tools: "Read,Bash"
          api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          settings: ${{ secrets.CLAUDE_SETTINGS }}
          allowed_bots: "agentfactory-bot[bot]"

      - name: Triage with agent (fallback model)
        id: triage_fallback
        if: steps.triage.outcome == 'failure' && vars.TRIAGE_FALLBACK_MODEL != ''
        continue-on-error: true
        uses: ./.github/actions/run-agent
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          engine: ${{ vars.TRIAGE_ENGINE || 'claude-code' }}
          prompt: |
            You are triaging a GitHub issue. Read /tmp/issue_context.md.

            Quickly evaluate:
            1. Is the desired behavior clearly described?
            2. Are acceptance criteria specified or inferable?
            3. Are there ambiguous requirements with multiple valid interpretations?

            Write your result to /tmp/triage_result.json:
            {
              "is_clear": true,
              "confidence": 0.9,
              "clarification_needed": null
            }

            Or if unclear:
            {
              "is_clear": false,
              "confidence": 0.4,
              "clarification_needed": {
                "question": "ONE specific question",
                "default_assumption": "what you'd assume if no answer",
                "why": "brief reason"
              }
            }

            Rules:
            - confidence >= 0.8 ‚Üí is_clear = true
            - Multiple valid interpretations ‚Üí is_clear = false
            - Write the JSON file immediately, do not over-analyze
          model: ${{ vars.TRIAGE_FALLBACK_MODEL }}
          max_turns: "5"
          allowed_tools: "Read,Bash"
          api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          settings: ${{ secrets.CLAUDE_SETTINGS }}
          allowed_bots: "agentfactory-bot[bot]"

      - name: Parse triage result
        id: parse
        run: |
          if [ ! -f /tmp/triage_result.json ]; then
            echo "::warning::Triage did not produce result file ‚Äî defaulting to clear"
            echo "is_clear=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IS_CLEAR=$(jq -r '.is_clear' /tmp/triage_result.json 2>/dev/null || echo "true")
          CONFIDENCE=$(jq -r '.confidence // 0' /tmp/triage_result.json 2>/dev/null || echo "0")
          echo "is_clear=${IS_CLEAR}" >> "$GITHUB_OUTPUT"
          echo "confidence=${CONFIDENCE}" >> "$GITHUB_OUTPUT"

          # Extract specification for the comment
          SPEC=$(jq -r '
            "### Current State\n" +
            (.specification.current_state // [] | map("- " + .) | join("\n")) +
            "\n\n### Desired State\n" +
            (.specification.desired_state // [] | map("- " + .) | join("\n")) +
            "\n\n### Files to Change\n" +
            (.specification.files_to_change // [] | map("- `" + . + "`") | join("\n")) +
            "\n\n### Acceptance Criteria\n" +
            (.specification.acceptance_criteria // [] | map("- [ ] " + .) | join("\n"))
          ' /tmp/triage_result.json 2>/dev/null || echo "Could not parse specification")
          # Write spec to file to avoid shell escaping issues
          echo "$SPEC" > /tmp/spec_comment.md

          # Extract clarification question if needed
          if [ "$IS_CLEAR" = "false" ]; then
            QUESTION=$(jq -r '.clarification_needed.question // "Could you provide more details?"' /tmp/triage_result.json)
            DEFAULT=$(jq -r '.clarification_needed.default_assumption // "N/A"' /tmp/triage_result.json)
            WHY=$(jq -r '.clarification_needed.why // ""' /tmp/triage_result.json)
            echo "question=${QUESTION}" >> "$GITHUB_OUTPUT"
            echo "default=${DEFAULT}" >> "$GITHUB_OUTPUT"
            echo "why=${WHY}" >> "$GITHUB_OUTPUT"
          fi

  # ‚îÄ‚îÄ Clear: post spec and dispatch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  dispatch:
    name: "Dispatch: Issue ‚Üí Agent"
    needs: triage
    if: needs.triage.outputs.is_clear == 'true' || needs.triage.result == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Remove clarification label if present
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh api "repos/${{ github.repository }}/issues/${{ needs.triage.outputs.issue_number }}/labels/needs-clarification" \
            -X DELETE 2>/dev/null || true

      - name: Post specification comment
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          ISSUE_NUMBER="${{ needs.triage.outputs.issue_number }}"
          RISK="${{ needs.triage.outputs.risk_tier }}"
          COMPLEXITY="${{ needs.triage.outputs.complexity }}"

          gh issue comment "${ISSUE_NUMBER}" \
            --repo "${{ github.repository }}" \
            --body "üëÄ **LailaTov** picked this up. Working on it now.

          - Risk tier: \`${RISK}\`
          - Complexity: \`${COMPLEXITY}\`
          - Branch: \`agent/cu-gh-${ISSUE_NUMBER}\`

          I'll open a draft PR when the code is ready."

      - name: Register task in web dashboard
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          WEB_URL: ${{ vars.WEB_URL || 'https://lailatov.vercel.app' }}
          CALLBACK_SECRET: ${{ secrets.CALLBACK_SECRET }}
          ISSUE_NUMBER: ${{ needs.triage.outputs.issue_number }}
          ISSUE_TITLE: ${{ needs.triage.outputs.title }}
          RISK_TIER: ${{ needs.triage.outputs.risk_tier }}
        run: |
          ISSUE_BODY=$(gh issue view "${ISSUE_NUMBER}" --repo "${{ github.repository }}" --json body -q .body)
          ISSUE_URL="https://github.com/${{ github.repository }}/issues/${ISSUE_NUMBER}"
          REPO_FULL_NAME="${{ github.repository }}"

          # Register in the web DB (non-blocking ‚Äî dispatch continues regardless)
          HTTP_CODE=$(curl -s -o /tmp/web_response.txt -w "%{http_code}" \
            -X POST "${WEB_URL}/api/tasks/from-issue" \
            -H "Content-Type: application/json" \
            -H "X-Callback-Secret: ${CALLBACK_SECRET}" \
            -d "$(jq -n \
              --arg repoFullName "${REPO_FULL_NAME}" \
              --arg issueNumber "${ISSUE_NUMBER}" \
              --arg title "${ISSUE_TITLE}" \
              --arg description "${ISSUE_BODY}" \
              --arg branch "agent/cu-gh-${ISSUE_NUMBER}" \
              --arg riskTier "${RISK_TIER}" \
              --arg issueUrl "${ISSUE_URL}" \
              '{repoFullName: $repoFullName, issueNumber: ($issueNumber | tonumber), title: $title, description: $description, branch: $branch, riskTier: $riskTier, issueUrl: $issueUrl}'
            )" 2>&1) || true
          if [ "$HTTP_CODE" -ge 400 ] 2>/dev/null; then
            echo "::warning::Web dashboard registration returned HTTP ${HTTP_CODE}: $(cat /tmp/web_response.txt 2>/dev/null)"
          else
            echo "Web dashboard registration OK (HTTP ${HTTP_CODE})"
          fi

      - name: Dispatch to agent-write
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ISSUE_NUMBER: ${{ needs.triage.outputs.issue_number }}
          TASK_ID: ${{ needs.triage.outputs.task_id }}
          RISK_TIER: ${{ needs.triage.outputs.risk_tier }}
          COMPLEXITY: ${{ needs.triage.outputs.complexity }}
        run: |
          # Get issue body for the dispatch payload
          ISSUE_BODY=$(gh issue view "${ISSUE_NUMBER}" --repo "${{ github.repository }}" --json body -q .body)
          ISSUE_TITLE=$(gh issue view "${ISSUE_NUMBER}" --repo "${{ github.repository }}" --json title -q .title)

          # Include any clarification comments as additional context
          COMMENTS=$(gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" \
            --jq '[.[] | select(.user.login != "agentfactory-bot[bot]") | .body] | join("\n\n---\n\n")' \
            2>/dev/null || echo "")

          if [ -n "$COMMENTS" ]; then
            FULL_DESCRIPTION="${ISSUE_BODY}

          ---
          ## Additional Context (from discussion)
          ${COMMENTS}"
          else
            FULL_DESCRIPTION="${ISSUE_BODY}"
          fi

          CORRELATION_ID=$(python3 -c "import uuid; print(uuid.uuid4())")

          # Build dispatch payload as JSON file to safely handle special characters
          # in issue title/body (backticks, $(), quotes, etc.)
          jq -n \
            --arg event_type "agent-task" \
            --arg task_id "${TASK_ID}" \
            --arg title "${ISSUE_TITLE}" \
            --arg description "${FULL_DESCRIPTION}" \
            --arg correlation_id "${CORRELATION_ID}" \
            --arg risk_tier "${RISK_TIER}" \
            --arg complexity "${COMPLEXITY}" \
            --arg source "github-issue" \
            --arg issue_number "${ISSUE_NUMBER}" \
            '{
              event_type: $event_type,
              client_payload: {
                clickup_task_id: $task_id,
                title: $title,
                description: $description,
                correlation_id: $correlation_id,
                risk_tier: $risk_tier,
                complexity: $complexity,
                source: $source,
                issue_number: $issue_number
              }
            }' > /tmp/dispatch_payload.json

          gh api "repos/${{ github.repository }}/dispatches" \
            --method POST \
            --input /tmp/dispatch_payload.json

          echo "Dispatched issue #${ISSUE_NUMBER} to agent-write"

  # ‚îÄ‚îÄ Unclear: ask for clarification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  clarify:
    name: "Clarify: Ask Question"
    needs: triage
    if: needs.triage.outputs.is_clear == 'false' && needs.triage.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Post clarification question
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          ISSUE_NUMBER="${{ needs.triage.outputs.issue_number }}"

          # Ensure labels exist
          gh label create "needs-clarification" \
            --color "FBCA04" \
            --description "Agent needs more info before implementing" \
            --repo "${{ github.repository }}" \
            2>/dev/null || true

          # Add needs-clarification, remove ai-agent (prevents re-trigger loop)
          gh issue edit "${ISSUE_NUMBER}" \
            --repo "${{ github.repository }}" \
            --add-label "needs-clarification" \
            --remove-label "ai-agent"

          # Post the question
          QUESTION="${{ needs.triage.outputs.question }}"
          DEFAULT="${{ needs.triage.outputs.default }}"
          WHY="${{ needs.triage.outputs.why }}"

          gh issue comment "${ISSUE_NUMBER}" \
            --repo "${{ github.repository }}" \
            --body "ü§î **LailaTov** needs a quick clarification before starting.

          **Question:** ${QUESTION}

          **My default assumption:** ${DEFAULT}

          ${WHY:+**Why this matters:** ${WHY}}

          ---
          *Just reply to this comment and I'll pick it up automatically. Or if my assumption is correct, just add the \`ai-agent\` label and I'll proceed with it.*"

  # ‚îÄ‚îÄ Triage failure: notify user ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  triage-failed:
    name: "Notify: Triage Failed"
    needs: triage
    if: >-
      needs.triage.result == 'failure' &&
      needs.triage.outputs.issue_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Post triage failure comment
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          ISSUE_NUMBER="${{ needs.triage.outputs.issue_number }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh issue comment "${ISSUE_NUMBER}" \
            --repo "${{ github.repository }}" \
            --body "‚ö†Ô∏è **LailaTov** encountered an error during triage.

          The issue was picked up but the triage step failed. I'll still attempt to work on it, but wanted you to know.

          [View workflow run](${RUN_URL})

          _If this keeps happening, please add the \`ai-agent\` label to retry._"
